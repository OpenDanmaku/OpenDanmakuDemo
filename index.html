<html>
<head><meta charset='utf-8'></head>
<body>
<div id="ad" style="background:#FFEFEF; color:#800000" onclick="ShowAD();">磁链弹幕OpenDanmaku项目诚邀志同道合者,详情请点击</div>
<div id="mainFloor" style="background:#FFD0D0; color:#800000"></div>
<br />
<div id="replyFloor" style="background:#FFEFEF; color:#800000"></div>
<script type="text/javascript">
	//全局变量

	
	Page_JSON=new Array()
	Page_ID=0;
	getLoop=0;
	maxLoop=0;
	MainFloor=new Object()
	UID="";
	maxLength=80;//默认多于80字符的也显示
	//获取页面ID或回复ID
	para=document.URL.split("=");
	if (para.length==2)maxLength=65535;//除非给两个参数,即都为主楼,或一个主楼一个回复
	var rid=parseInt(para.pop().replace(/[^0-9]/ig,""));
	var src_rid="http://h.acfun.tv/t/" + rid.toString() + ".json?callback=getRid";//	document.write(src_rid);
	//获取此条JSON,回调getRid
	var JSONP=document.createElement("script");
		JSONP.type="text/javascript";
		JSONP.src=src_rid;
		document.body.appendChild(JSONP);
	MyAD="<br>用途<br>　　　　提供一个按磁力链接索引的匿名弹幕服务器,以及相应的API,平台为新浪云<br>　　　　只要你提供magnet链接(中的btih编码),你可以借此在任何视频中分享弹幕<br>　　　　没错,任何视频,能干什么你懂的<br>功能<br>　　　　获取用户Cookie:并且有积分和操作硬直设定<br>　　　　新建/获取视频信息:最近一周的最热视频,最近一周投稿(时间倒序),某投稿信息<br>　　　　新建/获取弹幕信息:按序号/时间获取,获取最后x条弹幕,获取最新弹幕,获取全部弹幕<br>　　　　新建/获取交叉链接:允许不同压制格式,不同字幕组,或合集与单集之间相互共享弹幕<br>　　　　新建/获取云屏蔽:被dislike的弹幕可以隐藏,被dislike的人耗尽积分后会被禁言<br>　　　　详见&nbsp;https://github.com/OpenDanmaku/OpenDanmaku<br>状态<br>　　　　服务器端勉强写完了,因为是初学php,里面还存在大量的语法错误,<br>　　　　不优雅不简洁和漏洞,但是代码大致可以解释清楚功能<br>　　　　播放页预计将借用jabbany氏的ABPlayerHTML5/CommentCoreLibrary,<br>　　　　他的优秀作品甚至被a站html5播放器引用,谨表致意<br>　　　　在下不是专业学计算机和软件的,虽然有个小点子,<br>　　　　但是实践起来很苦手,项目整体还是未完成状态<br>　　　　如果有哪位感兴趣,欢迎加入OpenDanmaku小组,或者来fork代码,或者联系我schezuk@163.com<br>未来<br>　　　　理论上,我们可以实现一种弱中心的分布式匿名弹幕网络<br>　　　　借由与bt或magnet或ed2k绑定的分布式IRC(或插件),<br>　　　　利用这些协议现有的,或者自己设计的单独的聊天信道交换弹幕报文<br>　　　　仍然可以实现云屏蔽(用户对某条弹幕/某人标记dislike),跨弹幕池引用等等<br>　　　　专门的服务器提供分布式数据库储存,互相保持最终一致性,平时主要访问这个渠道<br>　　　　如果服务器不能访问,每个客户端也可以牺牲效率,直接互相同步弹幕<br>　　　　客户端监听每个anonymous&nbsp;user发布弹幕时的广播,互相传递本地弹幕cache,并用guid来去除重复<br>　　　　............<br>如果有哪位大神能来合作实现,不胜感激,请务必联系我schezuk@163.com";
	function ShowAD(){
		document.getElementById("ad").innerHTML+=MyAD;
		}
	
	function getRid(data){
		//获取显示的uid
		UID=data.threads.uid;
		//获取父页面ID
		Page_ID=data.threads.parent;
		if(data.threads.parent==0) Page_ID=data.threads.id;
		//else maxLength=80;//parent不为0,即给予两个参数,一个主楼一个回复
		//获取父页面JSON,回调getParent
		var src_parent="http://h.acfun.tv/t/" + Page_ID.toString() + ".json?callback=getParent";
		var JSONP=document.createElement("script");
			JSONP.type="text/javascript";
			JSONP.src=src_parent;
		document.body.appendChild(JSONP);
	}
	
	function getParent(data){
		//获取主楼
		MainFloor=data.threads;
		//获取循环次数,标记第一次循环
		maxLoop=data.page.size;//alert(maxLoop);
		getLoop=1;
		//获取第一个循环页面,回调getJSON
		var src_parent="http://h.acfun.tv/t/" + Page_ID.toString() + ".json?page=" + getLoop.toString() + "&callback=getJSON";
		var JSONP=document.createElement("script");
			JSONP.type="text/javascript";
			JSONP.src=src_parent;
		document.body.appendChild(JSONP);
	
	}
	function getJSON(data){
		//合并JSON
		//alert(typeof(data.replys));
		Page_JSON=Page_JSON.concat(data.replys);
		//合并完成,循环数自增1
		++getLoop;//alert(getLoop);
		if(getLoop<=maxLoop){//当循环小于等于上界,递归
			var src_parent="http://h.acfun.tv/t/" + Page_ID.toString() + ".json?page=" + getLoop.toString() + "&callback=getJSON";
			var JSONP=document.createElement("script");
				JSONP.type="text/javascript";
				JSONP.src=src_parent;
			document.body.appendChild(JSONP);
		}else{//当循环到达上界
			printJSON();
		}
	}
	function printJSON(){
		//alert(Page_JSON);
		//alert(Page_JSON.length);
		document.getElementById("mainFloor").innerHTML=printFloor(MainFloor);
		document.getElementById("replyFloor").innerHTML+=printReply();
	}
	function printFloor(data){
		var str="";
		str+="<b>"+data.uid.toString()+" "+data.name+" "+data.email+" "+data.title+" No."+data.id+"</b><br/>"+data.content+"<br>"
		if(data.image!="")str+="http://static.acfun.mm111.net/h/"+data.image+"<br>";
		return str;
	}
	function printReply(){
	var str="";
	for (x in Page_JSON){
		var this_JSON=Page_JSON[x];
		if((this_JSON.uid==UID) || (this_JSON.content.length>maxLength)) str+=printFloor(this_JSON);
		}
	return str;
	}

</script>
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F4de0917cb033c7cecf6a4b595e721f87' type='text/javascript'%3E%3C/script%3E"));
</script>
</body>
</html>

